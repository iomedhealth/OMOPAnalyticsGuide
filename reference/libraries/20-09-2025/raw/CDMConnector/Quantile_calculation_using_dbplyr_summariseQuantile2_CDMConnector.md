# Quantile calculation using dbplyr — summariseQuantile2 • CDMConnector

Skip to contents

[CDMConnector](../index.html) 2.2.0

  * [Reference](../reference/index.html)
  * Articles
    * [Getting Started](../articles/a01_getting-started.html)
    * [Working with cohorts](../articles/a02_cohorts.html)
    * [CDMConnector and dbplyr](../articles/a03_dbplyr.html)
    * [DBI connection examples](../articles/a04_DBI_connection_examples.html)
    * [Using CDM attributes](../articles/a06_using_cdm_attributes.html)
  * [Changelog](../news/index.html)


  *   * [](https://github.com/darwin-eu/CDMConnector/)



![](../logo.png)

# Quantile calculation using dbplyr

Source: [`R/summariseQuantile.R`](https://github.com/darwin-eu/CDMConnector/blob/HEAD/R/summariseQuantile.R)

`summariseQuantile2.Rd`

This function provides DBMS independent syntax for quantile estimation. Some database systems do not have a `quantile` function. The SQL generated by `summarizeQuantile2` should work on all supported database systems. This function can be added to a dplyr pipeline and adds an additional query to the input. No computation is triggered by `summarizeQuantile2` if the input is a `tbl` reference to a database table.

## Usage
    
    
    summariseQuantile2(.data, x, probs, nameSuffix = "{x}")

## Arguments

.data
    

lazy data frame backed by a database query created by `[dplyr::tbl()](https://dplyr.tidyverse.org/reference/tbl.html)`.

x
    

A string vector of column names whose sample quantiles are wanted.

probs
    

A numeric vector of probabilities with values in [0,1].

nameSuffix
    

A single character character string, evaluated by `[glue::glue()](https://glue.tidyverse.org/reference/glue.html)` that is appended to numerical quantile value as a column name part.

## Value

A lazy query with quantile calculation added. The result (after computation) will have one row per combination of grouping variables and one column for every variable/quantile combination. (see examples)

## Details

Implemented quantiles estimation algorithm returns values analogous to `quantile{stats}` with argument `type = 1`. See discussion in Hyndman and Fan (1996). Results differ from `PERCENTILE_CONT` natively implemented in various DBMS, where returned values are equal to `quantile{stats}` with default argument `type = 7`

[![\[Experimental\]](figures/lifecycle-experimental.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)

## Examples
    
    
    if (FALSE) { # \dontrun{
    con <- DBI::[dbConnect](https://dbi.r-dbi.org/reference/dbConnect.html)(duckdb::[duckdb](https://r.duckdb.org/reference/duckdb.html)())
    mtcars_tbl <- dplyr::[copy_to](https://dplyr.tidyverse.org/reference/copy_to.html)(con, mtcars, name = "tmp", overwrite = TRUE, temporary = TRUE)
    
    # quantiles for a single column
    mtcars_tbl [%>%](pipe.html)
      dplyr::[group_by](https://dplyr.tidyverse.org/reference/group_by.html)(cyl) [%>%](pipe.html)
      dplyr::[mutate](https://dplyr.tidyverse.org/reference/mutate.html)(mean = [mean](https://rdrr.io/r/base/mean.html)(mpg, na.rm = TRUE)) [%>%](pipe.html)
      summariseQuantile2("mpg", probs = [c](https://rdrr.io/r/base/c.html)(0, 0.2, 0.4, 0.6, 0.8, 1),  nameSuffix = "quant") [%>%](pipe.html)
      dplyr::[collect](https://dplyr.tidyverse.org/reference/compute.html)()
    
    #> cyl  p0_quant p20_quant p40_quant p60_quant p80_quant p100_quant
    #>   6      17.8      18.1      19.2      21        21         21.4
    #>   8      10.4      13.3      15        15.5      17.3       19.2
    #>   4      21.4      22.8      24.4      27.3      30.4       33.9
    
    # multiple columns
    mtcars_tbl [%>%](pipe.html)
      dplyr::[group_by](https://dplyr.tidyverse.org/reference/group_by.html)(cyl) [%>%](pipe.html)
      dplyr::[mutate](https://dplyr.tidyverse.org/reference/mutate.html)(mean = [mean](https://rdrr.io/r/base/mean.html)(mpg, na.rm = TRUE)) [%>%](pipe.html)
      summariseQuantile2([c](https://rdrr.io/r/base/c.html)("mpg", "hp", "wt"), probs = [c](https://rdrr.io/r/base/c.html)(0.2, 0.8),  nameSuffix = "{x}_quant") [%>%](pipe.html)
      dplyr::[collect](https://dplyr.tidyverse.org/reference/compute.html)()
    
    #>  cyl p20_mpg_quant p80_mpg_quant p20_hp_quant p80_hp_quant p20_wt_quant p80_wt_quant
    #>    4          22.8          30.4           65           97         1.84         2.78
    #>    6          18.1          21            110          123         2.77         3.44
    #>    8          13.3          17.3          175          245         3.44         5.25
    
    DBI::[dbDisconnect](https://dbi.r-dbi.org/reference/dbDisconnect.html)(con, shutdown = TRUE)
    } # }
    

## On this page

Developed by Adam Black, Artem Gorbachev, Edward Burn, Marti Catala Sabate, Ioanna Nika.

Site built with [pkgdown](https://pkgdown.r-lib.org/) 2.1.1.
