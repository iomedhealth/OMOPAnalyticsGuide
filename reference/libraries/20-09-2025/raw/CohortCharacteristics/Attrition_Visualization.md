# Page: Attrition Visualization

# Attrition Visualization

<details>
<summary>Relevant source files</summary>

The following files were used as context for generating this wiki page:

- [R/plotCohortAttrition.R](R/plotCohortAttrition.R)
- [man/plotCohortAttrition.Rd](man/plotCohortAttrition.Rd)
- [man/summariseCharacteristics.Rd](man/summariseCharacteristics.Rd)
- [tests/testthat/test-plotCohortAttrition.R](tests/testthat/test-plotCohortAttrition.R)

</details>



This document covers the visualization capabilities for cohort attrition analysis, specifically the `plotCohortAttrition()` function and its supporting infrastructure. This function creates flow diagrams that visualize subject and record flow through cohort definition steps, showing exclusions and remaining counts at each stage.

For information about generating attrition summaries, see [Attrition Summarization](#3.2.1). For creating formatted attrition tables, see [Attrition Tables](#3.2.3).

## Function Overview

The `plotCohortAttrition()` function serves as the primary interface for creating attrition flow diagrams. It accepts `summarised_result` objects generated by `summariseCohortAttrition()` and produces interactive flow diagrams using the DiagrammeR package.

```mermaid
flowchart TD
    INPUT["summarised_result object"]
    VALIDATE["Input Validation"]
    PREPARE["Data Preparation"]
    STYLE["Apply Styling"]
    GRAPH["Graph Construction"]
    EXPORT["Export to Format"]
    OUTPUT["Final Visualization"]
    
    INPUT --> VALIDATE
    VALIDATE --> PREPARE
    PREPARE --> STYLE
    STYLE --> GRAPH
    GRAPH --> EXPORT
    EXPORT --> OUTPUT
```

**Core Function Signature:**
- `plotCohortAttrition(result, show, type, cohortId)`
- `result`: A `summarised_result` object from attrition analysis
- `show`: Variables to display ("subjects", "records", or both)
- `type`: Output format ("htmlwidget", "png", "svg", "DiagrammeR")
- `cohortId`: Deprecated parameter for cohort filtering

Sources: [R/plotCohortAttrition.R:56-61]()

## Input Requirements

The function expects specific input formats and validates them through multiple pathways:

```mermaid
flowchart TD
    RESULT["Input: result parameter"]
    COHORT_TABLE["cohort_table object"]
    ATTRITION_DF["Data frame with attrition columns"]
    SUMMARISED_RESULT["summarised_result object"]
    
    ERROR1["Error: Use summariseCohortAttrition()"]
    CONVERT["Convert via summariseAttrition()"]
    VALIDATE["Validate with omopgenerics"]
    FILTER["Filter for result_type == 'summarise_cohort_attrition'"]
    
    RESULT --> COHORT_TABLE
    RESULT --> ATTRITION_DF  
    RESULT --> SUMMARISED_RESULT
    
    COHORT_TABLE --> ERROR1
    ATTRITION_DF --> CONVERT
    SUMMARISED_RESULT --> VALIDATE
    
    CONVERT --> VALIDATE
    VALIDATE --> FILTER
```

**Input Validation Process:**
- Rejects `cohort_table` objects directly with error message
- Converts data frames with cohort attrition columns via `summariseAttrition()`
- Validates `summarised_result` objects through `omopgenerics::validateResultArgument()`
- Filters for `result_type == "summarise_cohort_attrition"`

Sources: [R/plotCohortAttrition.R:71-91]()

## Output Formats and Types

The function supports multiple output formats through the `type` parameter, each requiring different processing and dependencies:

| Format | Description | Dependencies | Use Case |
|--------|-------------|--------------|----------|
| `htmlwidget` | Interactive web-based visualization | DiagrammeR | Default interactive output |
| `html` | HTML rendered version | DiagrammeR | Web embedding |
| `png` | Static PNG image | DiagrammeRsvg, rsvg, grid, png | Publication/reports |
| `svg` | Scalable vector graphics | DiagrammeRsvg | High-quality printing |
| `DiagrammeR` | Raw DiagrammeR graph object | DiagrammeR only | Further customization |

**Export Processing Pipeline:**
```mermaid
flowchart LR
    GRAPH["DiagrammeR Graph Object"]
    RENDER["DiagrammeR::render_graph()"]
    SVG_EXPORT["DiagrammeRsvg::export_svg()"]
    PNG_CONVERT["rsvg::rsvg_png()"]
    DISPLAY["grid::grid.raster()"]
    
    GRAPH --> RENDER
    RENDER --> SVG_EXPORT
    SVG_EXPORT --> PNG_CONVERT
    PNG_CONVERT --> DISPLAY
    
    GRAPH -.->|type='DiagrammeR'| OUTPUT1["Raw Graph"]
    RENDER -.->|type='htmlwidget'| OUTPUT2["Interactive Widget"]
    DISPLAY -.->|type='png'| OUTPUT3["PNG Image"]
```

Sources: [R/plotCohortAttrition.R:308-327]()

## Visualization Architecture

The attrition visualization system uses a modular architecture with distinct responsibilities for data processing, styling, and graph construction:

```mermaid
flowchart TD
    MAIN["plotCohortAttrition()"]
    
    subgraph "Data Processing"
        PREPARE_DATA["prepareData()"]
        LIMIT_MSG["limitMessage()"]
        SPLIT_ALL["omopgenerics::splitAll()"]
        PIVOT["omopgenerics::pivotEstimates()"]
    end
    
    subgraph "Graph Construction"
        PREPARE_GRAPH["prepareGraph()"]
        BOXES_POS["boxesPosition()"]
        ADD_NODES["DiagrammeR::add_node()"]
        ADD_EDGES["DiagrammeR::add_edge()"]
    end
    
    subgraph "Styling System"
        DEFAULT_STYLE["defaultStyle()"]
        STYLE_CONFIG["Style Configuration"]
    end
    
    subgraph "Export System"
        EXPORT_GRAPH["exportGraph()"]
        RENDER["DiagrammeR::render_graph()"]
    end
    
    MAIN --> PREPARE_DATA
    MAIN --> DEFAULT_STYLE
    MAIN --> PREPARE_GRAPH
    MAIN --> EXPORT_GRAPH
    
    PREPARE_DATA --> LIMIT_MSG
    PREPARE_DATA --> SPLIT_ALL
    PREPARE_DATA --> PIVOT
    
    PREPARE_GRAPH --> BOXES_POS
    PREPARE_GRAPH --> ADD_NODES
    PREPARE_GRAPH --> ADD_EDGES
    
    DEFAULT_STYLE --> STYLE_CONFIG
    STYLE_CONFIG --> PREPARE_GRAPH
```

Sources: [R/plotCohortAttrition.R:94-105](), [R/plotCohortAttrition.R:189-307]()

## Styling and Layout System

The visualization system includes a comprehensive styling framework that controls the appearance and positioning of diagram elements:

**Style Categories:**
- **Dimensions**: Width and height settings for different box types
- **Colors**: Background, font, and line colors for visual distinction
- **Typography**: Font families, sizes for different element types
- **Spacing**: Separation distances between elements

```mermaid
flowchart LR
    subgraph "Style Elements"
        TITLE_STYLE["Title Box Style"]
        COUNT_STYLE["Count Box Style"] 
        REASON_STYLE["Reason Box Style"]
        EXCLUDE_STYLE["Exclude Box Style"]
        ARROW_STYLE["Arrow Style"]
    end
    
    subgraph "Style Properties"
        DIMENSIONS["width_*, height_*"]
        COLORS["backgroundcolour_*, fontcolour_*, linecolour_*"]
        TYPOGRAPHY["fontname_*, fontsize_*"]
        SPACING["sep_*, line_height"]
    end
    
    TITLE_STYLE --> DIMENSIONS
    COUNT_STYLE --> DIMENSIONS
    REASON_STYLE --> DIMENSIONS
    EXCLUDE_STYLE --> DIMENSIONS
    ARROW_STYLE --> DIMENSIONS
    
    DIMENSIONS --> COLORS
    COLORS --> TYPOGRAPHY
    TYPOGRAPHY --> SPACING
```

**Default Style Configuration:**
- Background colors: Reason boxes (#F0F8FF), Count boxes (#FFFFFF), Exclude boxes (#F8F8F8)
- Font: Calibri family, size 8 for most elements
- Line height: 0.13 units for text spacing
- Box widths: Title (1), Reason (2), Count (1.2), Exclude (1.2)

Sources: [R/plotCohortAttrition.R:328-368]()

## Data Processing Pipeline

The data preparation process transforms `summarised_result` objects into structured data suitable for diagram construction:

```mermaid
flowchart TD
    RESULT["summarised_result Input"]
    JOIN_SETTINGS["Join with Settings (min_cell_count)"]
    SPLIT_ALL["Split All Grouped Data"]
    PIVOT_EST["Pivot Estimates by variable_name, estimate_name"]
    FORMAT_COUNTS["Format Counts with Cell Count Suppression"]
    GROUP_SPLIT["Group by cdm_name, cohort_name"]
    
    subgraph "Per-Cohort Processing"
        EXTRACT_META["Extract Title Metadata"]
        SORT_REASON["Sort by reason_id"]
        LIMIT_REASON["Limit Message Length (30 chars/line)"]
        BUILD_COUNT["Build Count Messages"]
        BUILD_EXCLUDE["Build Exclude Messages"]
    end
    
    RESULT --> JOIN_SETTINGS
    JOIN_SETTINGS --> SPLIT_ALL
    SPLIT_ALL --> PIVOT_EST
    PIVOT_EST --> FORMAT_COUNTS
    FORMAT_COUNTS --> GROUP_SPLIT
    GROUP_SPLIT --> EXTRACT_META
    
    EXTRACT_META --> SORT_REASON
    SORT_REASON --> LIMIT_REASON
    LIMIT_REASON --> BUILD_COUNT
    BUILD_COUNT --> BUILD_EXCLUDE
```

**Key Processing Steps:**
1. **Settings Integration**: Joins result data with min_cell_count settings for suppression
2. **Data Reshaping**: Uses `omopgenerics::splitAll()` and `pivotEstimates()` for structure transformation
3. **Count Formatting**: Applies cell count suppression (`<5`) and number formatting with commas
4. **Message Limiting**: Constrains text to 30 characters per line using `limitMessage()`
5. **Cohort Grouping**: Splits data by database and cohort name for separate diagrams

Sources: [R/plotCohortAttrition.R:151-189]()

## Helper Functions

The visualization system relies on several specialized helper functions that handle specific aspects of diagram construction:

### Message Formatting

The `limitMessage()` function ensures text fits within diagram boxes by implementing intelligent line wrapping:

**Text Wrapping Algorithm:**
- Maximum 30 characters per line
- Word-boundary breaking to preserve readability  
- Special character handling (apostrophes â†’ `\u00b4`)
- Newline joining for multi-line display

### Position Calculation

The `boxesPosition()` function calculates precise coordinates for all diagram elements:

**Positioning Logic:**
- **Title positioning**: Top of diagram with database/cohort metadata
- **Reason boxes**: Left-aligned, vertically stacked with calculated heights
- **Count boxes**: Below reason boxes, showing remaining subjects/records
- **Exclude boxes**: Right-aligned, showing excluded counts between steps
- **Cumulative spacing**: Maintains proper vertical separation between elements

### Graph Construction

The `prepareGraph()` function builds the complete DiagrammeR graph structure:

**Construction Process:**
1. Initialize empty DiagrammeR graph
2. Add title box with cohort metadata
3. Iterate through attrition steps:
   - Add count boxes with remaining subjects/records
   - Add reason boxes with exclusion criteria
   - Add exclude boxes with excluded counts
   - Connect elements with directional arrows
4. Apply consistent styling throughout

Sources: [R/plotCohortAttrition.R:128-150](), [R/plotCohortAttrition.R:369-420](), [R/plotCohortAttrition.R:190-307]()