---
knit: |
  (function(inputFile, encoding) {
    rmarkdown::render(
      inputFile,
      encoding = encoding,
      output_format = rmarkdown::github_document(html_preview = FALSE),
      output_file = file.path('../../_includes/rmd_output', paste0(tools::file_path_sans_ext(basename(inputFile)), '.md'))
    )
  })
---

Let's implements the study using the OHDSI CohortCharacteristics package to generate baseline profiles (“Table 1”) of one or more cohorts in the OMOP CDM, directly addressing the guide’s descriptive design.

## How CohortCharacteristics works

- **Summarise -> table/plot**: `summariseCohortCount`/`summariseCharacteristics` produce tidy `summarised_result` outputs consumed by `table…`/`plot…` helpers in `visOmopResults`.
- **Cohorts in, summaries out**: You provide one or more cohort tables (OMOP CDM structure). Functions compute counts, attrition, demographics, and clinical features at/before index.
- **Windows**: For granular baselines, large-scale summaries can use windows (e.g., -365:-1, 0:0, 1:365) around index.
- **Groups/strata**: Each cohort produces groups; you can stratify or facet by `cohort_name` and other variables in plots/tables.

## Practical guidance

- Use mock data for reproducibility.
- Keep cohort inclusion/exclusion logic in cohort construction; keep `summarise` functions descriptive.
- Save the `summarised_result` object and then render tables/plots.

## Step 1: Setup

This initial step focuses on preparing the R environment for the analysis. It involves loading libraries like `CDMConnector` and `CohortCharacteristics` makes their functions available for data manipulation and analysis. This foundational step is crucial for a reproducible and error-free workflow.

```{r setup-knitr, include=FALSE}
# Set up knitr options for knitting the Rmd file.
# The upload.fun option modifies the image path for embedding in the final document.
knitr::opts_knit$set(upload.fun = function(x) sub("^\\.\\./\\.\\./", "/", x))
# The fig.path option sets the directory where plots generated by the R code chunks will be saved.
knitr::opts_chunk$set(fig.path = "../../assets/images/rmd_output/")
```

```{r load-libraries, message=FALSE, warning=FALSE}
library(CDMConnector)
library(CohortCharacteristics)
library(visOmopResults)
library(DrugUtilisation)
```

## Step 2: Create a mock CDM and cohort

To ensure the analysis is reproducible and self-contained, we generate a mock Common Data Model (CDM) using the `DrugUtilisation` package. This simulated dataset mimics the structure of a real OMOP CDM, providing a safe and standardized environment for developing and testing analytical code. After creating the CDM, we define a cohort of interest—in this case, individuals exposed to acetaminophen. This step is vital for establishing the study population that will be characterized in the subsequent steps.

```{r create-mock-cdm, message=FALSE, warning=FALSE}
# Create a mock CDM object for demonstration purposes.
# This simulates a real CDM and populates it with synthetic data.
cdm <- DrugUtilisation::mockDrugUtilisation(numberIndividuals = 10000)

# Generate a cohort of individuals based on the ingredient "acetaminophen".
# This cohort will be used for the characterization analysis.
cdm <- generateIngredientCohortSet(
  cdm = cdm,
  name = "cohort",
  ingredient = "acetaminophen"
)
```

## Step 3: Cohort counts and attrition

Before diving into detailed characterization, it's important to understand the size and composition of the cohort. This step involves calculating the number of subjects and records in the generated cohort and examining the attrition process, which details how many individuals were excluded at each stage of the cohort definition. These summaries provide a high-level overview of the study population and help identify any potential issues with the cohort definition, ensuring the transparency and validity of the analysis.

```{r summarize-cohort-counts, message=FALSE, warning=FALSE}
# Summarize the number of subjects and records in the cohort.
counts <- summariseCohortCount(cdm$cohort)
# Display the cohort counts in a table.
tableCohortCount(counts)
```

```{r summarize-cohort-attrition, message=FALSE, warning=FALSE}
# Summarize the attrition of the cohort, showing how many subjects are dropped at each step of the cohort definition.
attr <- summariseCohortAttrition(cdm$cohort)
# Display the cohort attrition in a table.
tableCohortAttrition(attr)
```

## Step 4: Baseline characteristics (“Table 1”) and plots

This is the core of the patient-level characterization analysis. We generate a comprehensive summary of the cohort's baseline characteristics, often referred to as "Table 1." This table includes demographics, clinical events, and other relevant attributes of the study population at the time of cohort entry. Following the summary, we create visualizations to explore specific aspects of the data, such as the age distribution of the cohort. This step provides deep insights into the study population, which is essential for interpreting the results of any subsequent analyses.

```{r summarize-baseline-characteristics, message=FALSE, warning=FALSE}
# Summarize the baseline characteristics of the cohort.
# This creates a "Table 1" with demographics, conditions, drugs, etc.
chars <- summariseCharacteristics(cdm$cohort)
# Display the baseline characteristics in a table.
tableCharacteristics(chars)
```

```{r plot-age-distribution, message=FALSE, warning=FALSE}
# Create a plot of the age distribution by cohort.
# First, filter the characteristics data to select only the "Age" variable.
library(dplyr)
plot_data <- dplyr::filter(chars, variable_name == "Age")
# Generate a boxplot of the age distribution, colored by cohort name.
plotCharacteristics(plot_data, plotType = "boxplot", colour = "cohort_name")
```